#!/usr/bin/env node

var semver = require('semver');
var nopt   = require('nopt');
var path   = require('path');
var pkg    = require(path.join(__dirname, '..', 'package.json'));
var updateNotifier = require('update-notifier');
var chalk = require('chalk');

var template = require('../lib/util/template');
var artoo    = require('../lib');

var command;
var options;
var shorthand;
var input   = process.argv;
var nodeVer = process.version;
var reqVer  = pkg.engines.node;
var errors = [];

var notifier;

process.title = 'artoo';

if (reqVer && !semver.satisfies(nodeVer, reqVer)) {
  throw new Error('Required: node ' + reqVer);
}

options   = {
  version: Boolean
};

shorthand = {
  'v': ['--version']
};

options = nopt(options, shorthand, process.argv);

artoo.version = pkg.version; //set app version from package.json

if (options.version) return console.log(artoo.version);

command = options.argv.remain && options.argv.remain.shift();
command = artoo.abbreviations[command];

if (command) artoo.command = command;

artoo.commands[artoo.command || 'help'].line(input)
  .on('data', function (data) {
    if (data) process.stdout.write(data);
  })
  .on('end', function (data) {
    if (data) process.stdout.write(data);
  })
  .on('warn', function (warning)  {
    process.stderr.write(template('warn', { message: warning }, true));
  })
  .on('error', function (err)  {
    if (options.verbose) throw err;
    process.stdout.write(template('error', { message: err.message }, true));

    errors.push(err);
  });

// Check for newer version of Bower
notifier = updateNotifier({
    packageName: pkg.name,
    packageVersion: pkg.version,
    registryUrl: 'http://ipsos-mori-npm-registry.herokuapp.com/%s',
    callback: function(err, update) {
      if (!err && (update.type && update.type !== 'latest')) {
        var message =
            chalk.blue('----------------------------------------------------------------------------') +
            '\nUpdate available: ' + chalk.green.bold(update.latest) +
            chalk.gray(' (current: ' + update.current + ')') +
            '\nRun ' + chalk.magenta('npm install git+ssh://git@bitbucket.org:ipsosmori/artoo.git -g') +
            ' to update\n' +
            chalk.blue('----------------------------------------------------------------------------');
        console.log(message);
      }
    },
    updateCheckInterval: 1000 * 60 * 60 * 27 // 24 hr
});
